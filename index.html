<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tax Management - Bangladesh Tax Calculator</title>
   <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
  integrity="sha512-1K8JxYqZVqAfU9nBceZMb7RyFytk1DPyU9Cqz1rZjTv8jQbiuE6dL+gZW9rP1vPbJ7P7b76V6N7gYgY2+QvF8A=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* Extra for smooth fadeIn */
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hidden { display: none; }
        .link { text-decoration: underline; }
        table th, table td { padding: .5rem .75rem; border-bottom: 1px solid rgb(51 65 85/.4) }
        /* Style for the chart container */
        .chart-container {
            position: relative;
            height: 300px; /* Chart height */
            width: 100%;
        }

      .is-login-mode footer {
    display: none; 
}


    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-gray-900 to-slate-950 text-slate-100 font-sans">

<nav class="flex justify-between items-center p-4 bg-slate-900/90 backdrop-blur-lg fixed w-full z-50 shadow-2xl shadow-purple-900/50 border-b border-purple-500/20">
 <a href="" 
   class="text-3xl font-extrabold transition duration-300 hover:scale-[1.02] cursor-pointer no-underline">
   <span class="text-yellow-400">üí∞</span> 
   <span class="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-purple-500 hover:from-teal-300 hover:to-purple-400">
      Tax Manager
   </span>
</a>







    <div class="space-x-2 md:space-x-4 text-sm md:text-base font-medium">
        <button data-nav="landing" class="hover:text-teal-400 transition duration-150">Home</button>
        <button data-nav="auth" class="hover:text-teal-400 transition duration-150">Login/Register</button>
        <button data-nav="dashboard" class="hover:text-teal-400 transition duration-150">Dashboard</button>
        <button data-nav="documents" class="hover:text-teal-400 transition duration-150">Documents</button>
        <button id="nav-admin" data-nav="admin" class="hover:text-teal-400 transition duration-150 hidden">Admin</button>
        <button id="nav-logout" class="px-4 py-2 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg hover:shadow-xl transition duration-300 hidden">Logout</button>
        <span id="nav-username" class="hidden font-semibold text-teal-300 ml-3"></span>
    </div>
</nav>

<div class="pt-24 max-w-6xl mx-auto space-y-10">

    <section id="landing" class="fade-in">
        <div class="text-center py-20 px-4 rounded-3xl relative overflow-hidden
             bg-gradient-to-br from-purple-900 to-blue-700 
             shadow-2xl shadow-purple-900/80 
             border-4 border-white/10 ring-4 ring-purple-300/30 
             transition duration-500 hover:shadow-purple-600/90 hover:ring-purple-300/50">
            
            <h1 class="text-6xl font-black text-white mb-6 tracking-tight text-shadow-lg">
                Welcome to Tax Management
            </h1>
            <p class="text-xl text-purple-200 mb-8 font-light max-w-2xl mx-auto">
                Manage your taxes, documents & payments easily in one secure, digital place.
            </p>
            <button onclick="showSection('auth')" 
                    class="px-8 py-4 text-lg font-extrabold rounded-full 
                           bg-teal-400 text-slate-900 
                           shadow-2xl shadow-teal-500/80 
                           hover:bg-teal-300 hover:shadow-teal-400/90 
                           transition transform duration-300 hover:scale-105 active:scale-95 active:shadow-none 
                           border border-teal-200">
                Get Started Today
            </button>
        </div>

        <div class="grid md:grid-cols-3 gap-6 mt-12">
            <div class="bg-gray-800/70 p-6 rounded-xl shadow-2xl shadow-slate-900/80 hover:shadow-purple-500/30 transition transform hover:-translate-y-1 duration-300 text-center border-t-2 border-purple-500/50">
                <h3 class="text-2xl font-bold mb-2 text-purple-400">üíº Easy Management</h3>
                <p>Track your tax records and manage them efficiently with our powerful system.</p>
            </div>
            <div class="bg-gray-800/70 p-6 rounded-xl shadow-2xl shadow-slate-900/80 hover:shadow-purple-500/30 transition transform hover:-translate-y-1 duration-300 text-center border-t-2 border-purple-500/50">
                <h3 class="text-2xl font-bold mb-2 text-teal-400">üìÑ Document Storage</h3>
                <p>Securely store and access all your important financial documents anytime, anywhere.</p>
            </div>
            <div class="bg-gray-800/70 p-6 rounded-xl shadow-2xl shadow-slate-900/80 hover:shadow-purple-500/30 transition transform hover:-translate-y-1 duration-300 text-center border-t-2 border-purple-500/50">
                <h3 class="text-2xl font-bold mb-2 text-blue-400">üí≥ Payment Tracking</h3>
                <p>Monitor your payments and due dates with real-time updates and notifications.</p>
            </div>
        </div>

         <footer class="bg-gradient-to-r from-[#0a0a1a] to-[#121232] text-white py-10 shadow-[0_0_40px_rgba(115,0,255,0.4)] border-t border-cyan-400/30 mt-12">
  <div class="max-w-7xl mx-auto px-6 md:px-12 grid grid-cols-1 md:grid-cols-3 gap-10 text-center md:text-left">
    
    <!-- Logo Section -->
    <div>
      <h2 class="text-2xl font-extrabold bg-gradient-to-r from-cyan-400 via-fuchsia-500 to-purple-600 bg-clip-text text-transparent animate-pulse">
        üíº Tax Manager
      </h2>
      <p class="text-gray-400 mt-2">
        Manage your taxes easily, securely, and smartly in one digital platform.
      </p>
    </div>

    <!-- Links Section -->
    <div>
      <h3 class="text-cyan-400 font-semibold text-lg mb-3">Quick Links</h3>
      <ul class="space-y-2">
        <li><a href=" " class="text-gray-300 hover:text-cyan-400 transition-all hover:drop-shadow-[0_0_6px_#00e0ff]">Home</a></li>
        <li><a href=" " class="text-gray-300 hover:text-cyan-400 transition-all hover:drop-shadow-[0_0_6px_#00e0ff]">About</a></li>
        <li><a href=" " class="text-gray-300 hover:text-cyan-400 transition-all hover:drop-shadow-[0_0_6px_#00e0ff]">Features</a></li>
        <li><a href=" " class="text-gray-300 hover:text-cyan-400 transition-all hover:drop-shadow-[0_0_6px_#00e0ff]">Contact</a></li>
      </ul>
    </div>

    <!-- Social Media Section -->
   <div>
  <h3 class="text-cyan-400 font-semibold text-lg mb-3">Follow Us</h3>
  <div class="flex justify-center md:justify-start space-x-6 text-2xl mt-4">
    <a href="https://nbr.gov.bd/" class="text-gray-300 hover:text-blue-500 transition transform hover:scale-125 hover:rotate-6">
      <i class="fab fa-facebook-square"></i>
    </a>
    <a href="https://nbr.gov.bd/" class="text-gray-300 hover:text-sky-400 transition transform hover:scale-125 hover:rotate-6">
      <i class="fa-brands fa-twitter"></i>
    </a>
    <a href="https://nbr.gov.bd/" class="text-gray-300 hover:text-pink-500 transition transform hover:scale-125 hover:rotate-6">
      <i class="fa-brands fa-instagram"></i>
    </a>
    <a href="https://nbr.gov.bd/" class="text-gray-300 hover:text-blue-600 transition transform hover:scale-125 hover:rotate-6">
      <i class="fa-brands fa-linkedin-in"></i>
    </a>
    <a href="https://nbr.gov.bd/" class="text-gray-300 hover:text-gray-100 transition transform hover:scale-125 hover:rotate-6">
      <i class="fa-brands fa-github"></i>
    </a>
    <a href="https://nbr.gov.bd/" class="text-gray-300 hover:text-red-500 transition transform hover:scale-125 hover:rotate-6">
      <i class="fa-brands fa-youtube"></i>
    </a>
  </div>
</div>

  </div>

  <!-- Footer Bottom -->
  <div class="border-t border-gray-700 mt-10 pt-5 text-center text-sm text-gray-400">
    <p>Made  by <span class="text-cyan-400 font-semibold">Rovi</span> | ¬© 2025 Tax Manager. All Rights Reserved.</p>
  </div>
  <div id="footer-main-grid" class="max-w-7xl mx-auto px-6 md:px-12 grid grid-cols-1 md:grid-cols-3 gap-10 text-center md:text-left">
        

        <div id="quick-links-section"> </div>

        <div id="social-media-section"> </div>

    </div>
</footer>
    </section>

   




    <section id="auth" class="hidden fade-in">
        <div class="max-w-md mx-auto bg-slate-800/80 p-8 rounded-3xl backdrop-blur-lg shadow-2xl shadow-purple-900/70 space-y-6 border border-purple-600/50">
            <h1 class="text-3xl font-bold text-center text-teal-400">Tax Management</h1>
            <p class="text-center text-slate-300">Manage taxes, docs & payments</p>

            <div class="flex justify-center gap-4 mt-4">
                <button id="tab-login" class="px-5 py-2 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-semibold transition duration-200 shadow-lg shadow-purple-700/50 active:translate-y-0.5" onclick="switchTab('login')">Login</button>
                <button id="tab-register" class="px-5 py-2 rounded-xl bg-green-600 hover:bg-green-500 text-white font-semibold transition duration-200 shadow-lg shadow-green-700/50 active:translate-y-0.5" onclick="switchTab('register')">Register</button>
            </div>

            <div id="login-form" class="space-y-4 mt-4">
                <input id="login-email" type="email" placeholder="Email" class="w-full p-3 rounded-xl bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-purple-400/80 border border-slate-700">
                <input id="login-password" type="password" placeholder="Password" class="w-full p-3 rounded-xl bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-purple-400/80 border border-slate-700">
                <button class="w-full px-4 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 font-bold transition duration-200 shadow-xl shadow-purple-700/50 active:translate-y-0.5" onclick="login()">Secure Login</button>
            </div>

            <div id="register-form" class="hidden space-y-4 mt-4">
                <input id="reg-name" type="text" placeholder="Name" class="w-full p-3 rounded-xl bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-green-400/80 border border-slate-700">
                <input id="reg-email" type="email" placeholder="Email" class="w-full p-3 rounded-xl bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-green-400/80 border border-slate-700">
                <input id="reg-password" type="password" placeholder="Password" class="w-full p-3 rounded-xl bg-slate-700/70 focus:outline-none focus:ring-2 focus:ring-green-400/80 border border-slate-700">
                <button class="w-full px-4 py-3 rounded-xl bg-green-600 hover:bg-green-500 font-bold transition duration-200 shadow-xl shadow-green-700/50 active:translate-y-0.5" onclick="register()">Create Account</button>
            </div>

            <p class="text-center text-xs text-slate-400">Tip: Use an email containing <code>admin</code> to auto-create an admin account</p>
        </div>
    </section>
</div>

    <section id="dashboard" class="hidden fade-in space-y-8">
        <h2 class="text-3xl font-bold text-center text-purple-400">Bangladesh Income Tax Calculator</h2>
        <div class="grid lg:grid-cols-3 gap-6">

            <div class="
                bg-slate-800/60 p-6 rounded-3xl
                shadow-xl space-y-4 text-white
                transition duration-300 transform
                hover:-translate-y-2 hover:shadow-2xl hover:scale-[1.01]
                hover:ring-2 hover:ring-purple-500 lg:col-span-1
            ">
                <h3 class="text-xl font-bold border-b border-purple-500/50 pb-2">‡¶Ü‡ßü‡¶ï‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ï‡¶∞‡ßÅ‡¶® (Calculate Income Tax)</h3>
                <div class="space-y-3">
                    <label class="block text-sm font-medium">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡ßé‡¶∏‡¶∞‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º (Total Annual Income - BDT)</label>
                    <input id="annual-income" type="number" step="1000" placeholder="e.g., 800000" class="w-full p-3 rounded-lg bg-slate-700/50 text-white placeholder-slate-400 focus:outline-purple-400" value="800000">
                </div>
                <div class="space-y-3">
                    <label class="block text-sm font-medium">‡¶ï‡¶∞‡¶¶‡¶æ‡¶§‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞ (Taxpayer Type)</label>
                    <select id="taxpayer-type" class="w-full p-3 rounded-lg bg-slate-700/50 text-white focus:outline-purple-400">
                        <option value="male">‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑ (Male)</option>
                        <option value="female">‡¶®‡¶æ‡¶∞‡ßÄ / ‡ß¨‡ß´+ ‡¶™‡ßç‡¶∞‡¶¨‡ßÄ‡¶£ / ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡ßÄ</option>
                        <option value="freedom_fighter">‡¶ó‡ßá‡¶ú‡ßá‡¶ü‡ßá‡¶° ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶Ø‡ßã‡¶¶‡ßç‡¶ß‡¶æ</option>
                    </select>
                </div>
                <div class="space-y-3">
                    <label class="block text-sm font-medium">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶¨‡¶æ ‡¶õ‡¶æ‡¶°‡¶º (Total Investment/Exemption - BDT)</label>
                    <input id="tax-exempt" type="number" step="1000" placeholder="e.g., 200000" class="w-full p-3 rounded-lg bg-slate-700/50 text-white placeholder-slate-400 focus:outline-purple-400" value="0">
                    <p class="text-xs text-slate-400">Investment Rebate is calculated based on this amount.</p>
                </div>
                <button class="w-full px-4 py-3 rounded-lg bg-purple-600 hover:bg-purple-700 transition duration-150 font-semibold text-lg" onclick="calculateBDTax()">Calculate Tax</button>
            </div>

            <div class="lg:col-span-2 space-y-6">

                <div class="
                    bg-slate-800/60 p-6 rounded-3xl
                    shadow-xl space-y-3 text-white
                    transition duration-300 transform
                    hover:shadow-2xl hover:scale-[1.01]
                    hover:ring-2 hover:ring-blue-500
                ">
                    <h3 class="text-xl font-bold border-b border-blue-500/50 pb-2">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ (Calculation Summary)</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm md:text-base">
                        <div class="flex justify-between p-2 bg-slate-700/50 rounded-lg"><span>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º (Annual Income)</span><strong id="res-income">0.00</strong></div>
                        <div class="flex justify-between p-2 bg-slate-700/50 rounded-lg"><span>‡¶ï‡¶∞‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶∏‡ßÄ‡¶Æ‡¶æ (Tax Exempt Limit)</span><strong id="res-exempt-limit">0.00</strong></div>
                        <div class="flex justify-between p-2 bg-slate-700/50 rounded-lg"><span>‡¶ï‡¶∞‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Ü‡¶Ø‡¶º (Taxable Income)</span><strong id="res-taxable">0.00</strong></div>
                        <div class="flex justify-between p-2 bg-slate-700/50 rounded-lg"><span>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º‡¶ï‡¶∞ (Gross Tax)</span><strong id="res-gross-tax">0.00</strong></div>
                        <div class="flex justify-between p-2 bg-slate-700/50 rounded-lg"><span>‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶∞‡ßá‡ßü‡¶æ‡¶§ (Investment Rebate)</span><strong id="res-rebate">0.00</strong></div>
                        <div class="flex justify-between p-2 bg-slate-700/50 rounded-lg font-bold text-lg text-green-300"><span>‡¶™‡ßç‡¶∞‡¶¶‡ßá‡ßü ‡¶Ü‡¶Ø‡¶º‡¶ï‡¶∞ (Net Payable Tax)</span><strong id="res-net-tax">0.00</strong></div>
                    </div>
                    <p class="text-xs text-slate-400 pt-2">Minimum Tax (‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶ï‡¶∞): <strong id="res-min-tax">0000.00</strong> (Applicable if calculated tax is less than min tax)</p>
                </div>

                <div class="
                    bg-slate-800/60 p-6 rounded-3xl
                    shadow-xl space-y-3 text-white
                    transition duration-300 transform
                    hover:shadow-2xl hover:ring-2 hover:ring-green-500
                ">
                    <h3 class="text-xl font-bold border-b border-green-500/50 pb-2">‡¶ü‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ú‡¶® (Tax Slab Breakdown)</h3>
                    <div class="chart-container">
                        <canvas id="taxChart"></canvas>
                    </div>
                </div>

            </div>
        </div>

      
    </section>

    <section id="documents" class="hidden fade-in space-y-8 text-white">

        <div class="
            bg-slate-800/60 p-6 rounded-3xl
            shadow-xl space-y-3
            transition duration-300 transform
            hover:-translate-y-2 hover:shadow-2xl hover:scale-[1.01]
            hover:ring-2 hover:ring-purple-500
        ">
            <h3 class="text-xl font-bold mb-2">Upload Document</h3>
            <form id="uploadForm" class="flex flex-col gap-2">
                <input type="file" id="fileInput" class="p-2 rounded-lg bg-slate-700/50 text-white" />
                <button class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 transition duration-150" type="submit">Upload</button>
            </form>
            <p class="text-xs text-slate-400 mt-2">Files are stored in browser storage. Clearing site data will remove them.</p>
        </div>

        <div class="
            bg-slate-800/60 p-6 rounded-3xl
            shadow-xl overflow-x-auto
            transition duration-300 transform
            hover:shadow-2xl hover:ring-2 hover:ring-blue-500
        ">
            <h3 class="text-xl font-bold mb-2">Your Documents</h3>
            <table class="w-full text-left border-collapse mt-4">
                <thead>
                    <tr class="
                        bg-slate-700/70
                        hover:bg-slate-600/80
                        transition duration-200
                        shadow-md rounded-lg
                    ">
                        <th class="p-3 rounded-tl-lg">File</th>
                        <th class="p-3">Size</th>
                        <th class="p-3">Uploaded</th>
                        <th class="p-3 rounded-tr-lg">Actions</th>
                    </tr>
                </thead>
                <tbody id="doc-table"></tbody>
            </table>
        </div>
    </section>
    
     <!-- Amin Section -->
    <section id="admin" class="hidden fade-in space-y-8 text-white">
        <div class="grid md:grid-cols-2 gap-6">

            <div class="
                bg-slate-800/60 p-6 rounded-3xl
                shadow-xl space-y-3
                transition duration-300 transform
                hover:-translate-y-2 hover:shadow-2xl hover:scale-[1.01]
                hover:ring-2 hover:ring-indigo-500
            ">
                <h3 class="text-xl font-bold">System Overview</h3>
                <div class="flex justify-between"><span>Total Users</span><strong id="ad-users">0</strong></div>
                <div class="flex justify-between"><span>Total Transactions</span><strong id="ad-txs">0</strong></div>
            </div>

            <div class="
                bg-slate-800/60 p-6 rounded-3xl
                shadow-xl overflow-x-auto
                transition duration-300 transform
                hover:shadow-2xl hover:ring-2 hover:ring-green-500
            ">
                <h3 class="text-xl font-bold mb-2">Latest Transactions</h3>
                <table class="w-full text-left border-collapse mt-4">
                    <thead>
                        <tr class="
                            bg-slate-700/70
                            hover:bg-slate-600/80
                            transition duration-200
                            shadow-md rounded-lg
                        ">
                            <th class="p-3 rounded-tl-lg">User</th>
                            <th class="p-3">Type</th>
                            <th class="p-3">Category</th>
                            <th class="p-3">Amount</th>
                            <th class="p-3 rounded-tr-lg">Date</th>
                        </tr>
                    </thead>
                    <tbody id="ad-table">
                    </tbody>
                </table>
            </div>

        </div>
    </section>

</div>

<script>
/**********************
 * Utilities & Storage
 **********************/
const STORAGE_KEYS = {
    users: 'tm_users',
    txs: 'tm_transactions',
    docs: 'tm_documents',
    auth: 'tm_auth',
};

const BD_MIN_TAX = 0;

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

function readLS(key, fallback = null){
    try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
}
function writeLS(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

function currentUser(){ return readLS(STORAGE_KEYS.auth, null); }
function setCurrentUser(u){ writeLS(STORAGE_KEYS.auth, u); }

/**********************
 * Toast (Option B)
 **********************/
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if(!container) return; // if HTML not updated, silently ignore

    const id = 'toast-' + uid();
    const el = document.createElement('div');
    el.id = id;
    // Tailwind-ish classes (rely on tailwind loaded in your page)
    const base = 'px-4 py-2 rounded shadow-lg text-white max-w-sm break-words';
    const classes = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-blue-600'
    };
    el.className = `${base} ${classes[type] || classes.info} animate__animated`;
    el.style.transition = 'opacity 300ms ease, transform 300ms ease';
    el.style.opacity = '1';

    el.textContent = message;
    container.appendChild(el);

    // auto remove
    setTimeout(()=>{
        el.style.opacity = '0';
        el.style.transform = 'translateY(8px)';
        setTimeout(()=> container.removeChild(el), 350);
    }, 2600);
}

/**********************
 * Navigation & UI
 **********************/
function refreshNav(){
    const u = currentUser();
    const isAuthed = !!u;

    // show/hide the dashboard/documents navigation (buttons have data-nav attributes)
    $$('[data-nav]').forEach(btn=>{
        const navKey = btn.getAttribute('data-nav');
        if(navKey === 'dashboard' || navKey === 'documents'){
            btn.classList.toggle('hidden', !isAuthed);
        }
    });

    // Admin button (id='nav-admin' exists in HTML)
    const isAdmin = isAuthed && u?.role === 'ADMIN';
    const navAdmin = $('#nav-admin');
    if(navAdmin) navAdmin.classList.toggle('hidden', !isAdmin);

    // Hide the 'Login/Register' navigator (data-nav="auth") when authed
    const authBtn = document.querySelector('[data-nav="auth"]');
    if(authBtn) authBtn.classList.toggle('hidden', isAuthed);

    // Logout button (id='nav-logout') visibility
    const navLogout = $('#nav-logout');
    if(navLogout) navLogout.classList.toggle('hidden', !isAuthed);

    // Show username in navbar if logged in
    const nameBox = $('#nav-username');
    if(nameBox){
        if(u){
            nameBox.textContent = `Welcome, ${u.name}`;
            nameBox.classList.remove('hidden');
        } else {
            nameBox.textContent = '';
            nameBox.classList.add('hidden');
        }
    }
}

// Single showSection with auth guard for dashboard/documents
function showSection(id){
    // hide all sections first
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));

    // protect certain sections
    if((id === 'dashboard' || id === 'documents' || id === 'admin') && !currentUser()){
        showToast('Please login first', 'error');
        // show auth area (login/register)
        document.getElementById('auth')?.classList.remove('hidden');
        refreshNav();
        return;
    }

    const el = document.getElementById(id);
    if(el) el.classList.remove('hidden');

    // lazy-initialize when entering specific sections
    if(id === 'dashboard'){
        // call only if those functions exist to avoid runtime errors
        if(typeof loadTransactions === 'function') loadTransactions();
        if(typeof loadOverview === 'function') loadOverview();
        if(typeof renderReminders === 'function') renderReminders();
        if(typeof calculateBDTax === 'function') calculateBDTax();
    }
    if(id === 'documents') renderDocuments();
    if(id === 'admin'){ if(typeof ensureAdmin === 'function') ensureAdmin(); if(typeof renderAdmin === 'function') renderAdmin(); }

    refreshNav();
}

// hook nav buttons (data-nav exists in your HTML)
$$('[data-nav]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-nav');
        if(target === 'admin' && typeof ensureAdmin === 'function') ensureAdmin();
        showSection(target);
    });
});

// logout button
if($('#nav-logout')) $('#nav-logout').addEventListener('click', logout);

/**********************
 * Auth (register/login/logout)
 **********************/
function users(){ return readLS(STORAGE_KEYS.users, []); }
function saveUsers(arr){ writeLS(STORAGE_KEYS.users, arr); }

function switchTab(which){
    document.getElementById('login-form').classList.toggle('hidden', which !== 'login');
    document.getElementById('register-form').classList.toggle('hidden', which === 'login');
    document.getElementById('tab-login').classList.toggle('bg-purple-600', which === 'login');
    document.getElementById('tab-login').classList.toggle('bg-slate-700', which !== 'login');
    document.getElementById('tab-register').classList.toggle('bg-green-600', which === 'register');
    document.getElementById('tab-register').classList.toggle('bg-slate-700', which !== 'register');
}

function register(){
    const name = $('#reg-name').value.trim();
    const email = $('#reg-email').value.trim().toLowerCase();
    const pass = $('#reg-password').value.trim();
    if(!name || !email || !pass) { showToast('Fill all fields', 'error'); return; }
    const exists = users().some(u => u.email === email);
    if(exists){ showToast('Email already registered', 'error'); return; }
    const role = email.includes('admin') ? 'ADMIN' : 'USER'; // demo rule
    const newUser = { id: uid(), name, email, role };
    saveUsers([...users(), newUser]);
    // don't auto-send to dashboard ‚Äî show toast and switch to login
    setCurrentUser(null); // ensure not logged in automatically; user should login
    showToast('Registration successful. Please login.', 'success');
    // switch to login tab and keep auth section visible
    switchTab('login');
    refreshNav();
}

function login(){
    const email = $('#login-email').value.trim().toLowerCase();
    const pass = $('#login-password').value.trim();
    if(!email || !pass) { showToast('Fill all fields', 'error'); return; }
    const u = users().find(u => u.email === email);
    if(!u){ showToast('No account found. Please register.', 'error'); switchTab('register'); return; }
    // NOTE: Password omitted in this demo ‚Äî production must validate
    setCurrentUser(u);
    showToast('Login successful!', 'success');
    refreshNav();
    // After login, allow access to dashboard then show it
    showSection('dashboard');
}

function logout(){
    localStorage.removeItem(STORAGE_KEYS.auth);
    showToast('Logged out', 'info');
    refreshNav();
    showSection('landing');
}

/**********************
 * Transactions helpers (kept minimal)
 **********************/
function allTxs(){ return readLS(STORAGE_KEYS.txs, []); }
function saveTxs(arr){ writeLS(STORAGE_KEYS.txs, arr); }

/**********************
 * BD Tax Calc functions
 * (kept mostly as your original, minor safe-checks added)
 **********************/
let taxChart = null;

const fmtMoney = (n) => (Number(n)||0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

function calculateIncomeTaxBD(annualIncome, type, investmentAmount) {
    let exemptLimit;
    const income = Number(annualIncome) || 0;
    const investment = Number(investmentAmount) || 0;

    switch(type) {
        case 'female':
            exemptLimit = 375000;
            break;
        case 'freedom_fighter':
            exemptLimit = 500000;
            break;
        case 'male':
        default:
            exemptLimit = 350000;
            break;
    }

    const taxableIncome = Math.max(0, income - exemptLimit);
    let grossTax = 0;
    let remainingTaxable = taxableIncome;
    const taxSlabs = [];

    const slabs = [
        { limit: 100000, rate: 0.05, name: "First 1 Lakh (5%)" },
        { limit: 300000, rate: 0.10, name: "Next 3 Lakh (10%)" },
        { limit: 400000, rate: 0.15, name: "Next 4 Lakh (15%)" },
        { limit: 500000, rate: 0.20, name: "Next 5 Lakh (20%)" },
        { limit: Infinity, rate: 0.25, name: "Balance (25%)" }
    ];

    for(const slab of slabs) {
        let amountInSlab = (slab.limit === Infinity) ? remainingTaxable : Math.min(remainingTaxable, slab.limit);
        if(amountInSlab > 0){
            const tax = amountInSlab * slab.rate;
            grossTax += tax;
            remainingTaxable -= amountInSlab;
            taxSlabs.push({ name: slab.name, taxableAmount: amountInSlab, taxAmount: tax });
        }
        if(remainingTaxable <= 0) break;
    }

    const maxRebateBase = Math.min(investment, income * 0.20, 10000000);
    const rebateAmount = maxRebateBase * 0.15;
    let netTax = grossTax - rebateAmount;
    netTax = Math.max(netTax, BD_MIN_TAX);

    return {
        exemptLimit,
        taxableIncome,
        grossTax,
        rebateAmount: Math.max(0, rebateAmount),
        netTax: Math.max(0, netTax),
        taxSlabs
    };
}

function calculateBDTax(){
    const annualIncome = $('#annual-income') ? $('#annual-income').value : 0;
    const taxpayerType = $('#taxpayer-type') ? $('#taxpayer-type').value : 'male';
    const taxExempt = $('#tax-exempt') ? $('#tax-exempt').value : 0;

    const income = parseFloat(annualIncome) || 0;
    const exempt = parseFloat(taxExempt) || 0;

    const result = calculateIncomeTaxBD(income, taxpayerType, exempt);

    // Update results if elements exist
    if($('#res-income')) $('#res-income').textContent = fmtMoney(income);
    if($('#res-exempt-limit')) $('#res-exempt-limit').textContent = fmtMoney(result.exemptLimit);
    if($('#res-taxable')) $('#res-taxable').textContent = fmtMoney(result.taxableIncome);
    if($('#res-gross-tax')) $('#res-gross-tax').textContent = fmtMoney(result.grossTax);
    if($('#res-rebate')) $('#res-rebate').textContent = fmtMoney(result.rebateAmount);
    if($('#res-min-tax')) $('#res-min-tax').textContent = fmtMoney(BD_MIN_TAX);
    if($('#res-net-tax')) $('#res-net-tax').textContent = fmtMoney(result.netTax);

    if(typeof renderTaxChart === 'function') renderTaxChart(result.taxSlabs, result.netTax);
}

function renderTaxChart(slabs, netTax){
    const ctxEl = document.getElementById('taxChart');
    if(!ctxEl) return;
    const ctx = ctxEl.getContext('2d');

    const labels = slabs.map(s => s.name);
    const data = slabs.map(s => s.taxAmount || s.taxAmount === 0 ? s.taxAmount : s.taxableAmount * 0);

    if(data.every(d => d === 0) && netTax > 0){
        labels.push("Minimum Tax / (Net Tax)");
        data.push(netTax);
    }

    if(taxChart) try { taxChart.destroy(); } catch(e){}

    taxChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Tax Amount (BDT)',
                data,
                backgroundColor: ['rgba(192,132,252,0.7)','rgba(129,140,248,0.7)','rgba(96,165,250,0.7)','rgba(52,211,163,0.7)','rgba(251,191,36,0.7)','rgba(248,113,113,0.7)'],
                borderColor: ['rgba(192,132,252,1)','rgba(129,140,248,1)','rgba(96,165,250,1)','rgba(52,211,163,1)','rgba(251,191,36,1)','rgba(248,113,113,1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: 'rgb(203 213 225)' } },
                x: { ticks: { color: 'rgb(203 213 225)' } }
            },
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Income Tax Calculation Breakdown', color: 'rgb(203 213 225)' }
            }
        }
    });
}

/**********************
 * Reminders (safe)
 **********************/
function renderReminders(){
    const ul = $('#reminders');
    if(!ul) return;
    const items = [];
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();

    const quarters = [ new Date(y,0,15), new Date(y,3,15), new Date(y,6,15), new Date(y,9,15) ];
    quarters.forEach(d => {
        const daysLeft = Math.ceil((d - now)/(1000*60*60*24));
        if(daysLeft >= 0 && daysLeft <= 30) items.push(`Advance tax due on ${d.toISOString().slice(0,10)} (in ${daysLeft} days)`);
    });

    // hadVAT: if txsForUser exists use it, else skip
    let hadVAT = false;
    if(typeof txsForUser === 'function'){
        try {
            hadVAT = txsForUser().some(t => {
                const dt = new Date(t.date);
                return t.taxCat === 'VAT' && dt.getFullYear() === y && dt.getMonth() === m;
            });
        } catch(e){ hadVAT = false; }
    }
    if(hadVAT){
        const due = new Date(y, m+1, 15);
        const daysLeft = Math.ceil((due - now)/(1000*60*60*24));
        if(daysLeft >= 0) items.push(`VAT return/payment due on ${due.toISOString().slice(0,10)} (in ${daysLeft} days)`);
    }

    let returnDue = new Date(y, 10, 30);
    if(now.getMonth() > 10) returnDue = new Date(y+1, 10, 30);
    const daysLeftRT = Math.ceil((returnDue - now)/(1000*60*60*24));
    if(daysLeftRT >=0 && daysLeftRT <= 90) items.push(`Tax Return Submission due on ${returnDue.toISOString().slice(0,10)} (in ${daysLeftRT} days)`);

    ul.innerHTML = items.length ? items.map(i => `<li>${i}</li>`).join('') : '<li class="text-slate-400">No upcoming reminders.</li>';
}

/**********************
 * Documents (BASE64 storage for persistent download)
 **********************/
/* helper: file -> base64 */
function fileToBase64(file){
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function allDocs(){ return readLS(STORAGE_KEYS.docs, []); }
function saveDocs(arr){ writeLS(STORAGE_KEYS.docs, arr); }

function renderDocuments(){
    const u = currentUser();
    const tbody = $('#doc-table');
    if(!tbody) return;
    if(!u){
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-slate-400 py-3">Please login to view your documents.</td></tr>`;
        return;
    }

    const list = allDocs().filter(d => d.userId === u.id).sort((a,b) => b.uploadedAt.localeCompare(a.uploadedAt));
    if(list.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-slate-400 py-3">No documents yet.</td></tr>`;
        return;
    }

    tbody.innerHTML = list.map(d => `
        <tr>
            <td>${d.name}</td>
            <td>${(d.size/1024).toFixed(1)} KB</td>
            <td>${d.uploadedAt.replace('T',' ').slice(0,16)}</td>
            <td>
                ${d.data ? `<a class="link" href="${d.data}" download="${d.name}">Download</a> ¬∑ ` : ''}
                <button class="text-red-300 hover:text-red-400" onclick="deleteDoc('${d.id}')">Delete</button>
            </td>
        </tr>
    `).join('');
}

function deleteDoc(id){
    if(!confirm('Delete this document?')) return;
    const doc = allDocs().find(x => x.id === id);
    // no need to revoke ObjectURL because we store base64
    saveDocs(allDocs().filter(x => x.id !== id));
    renderDocuments();
}

// Upload handler: convert to base64 and save (persistent)
const uploadForm = document.getElementById('uploadForm');
if(uploadForm){
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const u = currentUser();
        if(!u){ showToast('Please login to upload files', 'error'); return; }

        const fileInput = document.getElementById('fileInput');
        const file = fileInput?.files?.[0];
        if(!file){ showToast('Choose a file first', 'error'); return; }

        try {
            const base64 = await fileToBase64(file);
            const doc = {
                id: uid(),
                userId: u.id,
                name: file.name,
                size: file.size,
                uploadedAt: new Date().toISOString(),
                data: base64
            };
            saveDocs([doc, ...allDocs()]);
            fileInput.value = '';
            showToast('File uploaded successfully', 'success');
            renderDocuments();
        } catch(err){
            console.error(err);
            showToast('File upload failed', 'error');
        }
    });
}

/**********************
 * Admin helpers
 **********************/
function renderAdmin(){
    const usersArr = users();
    const txsArr = allTxs();
    if($('#ad-users')) $('#ad-users').textContent = String(usersArr.length);
    if($('#ad-txs')) $('#ad-txs').textContent = String(txsArr.length);
}

/**********************
 * Bootstrap init
 **********************/
document.addEventListener('DOMContentLoaded', ()=>{
    // prefill overview inputs safely if present
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
    const end = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().slice(0,10);
    if($('#ov-start')) $('#ov-start').value = start;
    if($('#ov-end')) $('#ov-end').value = end;

    // ensure nav state and default view
    refreshNav();
    // if user logged-in, go to dashboard; otherwise landing
    if(currentUser()) showSection('dashboard'); else showSection('landing');
});
</script>
<div id="toast-container" class="fixed bottom-5 right-5 space-y-3 z-50"></div>
</body>
</html>